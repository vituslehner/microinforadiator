<!DOCTYPE html>
<!--
  ~ Copyright (c) 2017. Vitus Lehner. UrbanLife+. Universität der Bundeswehr München.
  -->

<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <meta charset="UTF-8"/>
    <title>UrbanLife+ Microinforadiator Overview</title>

    <style type="text/css">
        html, body {
            font-family: "Helvetica Neue", "Helvetica", sans-serif;
            background-color: #F2F1F2;
        }

        #wrapper {
            width: 95%;
            margin: 25px auto;
            padding: 20px;
            background-color: #FFFFFF;
            border: 1px solid #DDDDDD;
            border-radius: 5px;
        }

        #map {
            width: 100%;
            height: 500px;
        }
    </style>
    <!-- Eclipse Paho JavaScript MQTT Client -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"
            type="text/javascript"></script>
</head>
<body>
<div id="wrapper">
    <h2>Mikroinformationsstrahler</h2>
    <hr/>
    <p>UrbanLife+ | MIR-ID: <strong th:text="${mir_id}"/> <span th:text="${message}"/></p>
    <hr/>
    <div id="map"></div>
    <hr/>
    <div id="controls">
        <table style="border:0;margin:0;padding:0;width:100%">
            <tr>
                <td>
                    <h2>Margot Nowak</h2>
                    <form onsubmit="return false;">
                        <p>
                            <label>Start:
                                <select name="margot_start" onchange="margotCalcShow()">
                                    <option>Hardterbroicher Str. 107, 41065 Mönchengladbach</option>
                                    <option>Bungtstraße 1, 41065 Mönchengladbach</option>
                                    <option>Bungtstraße 2, 41065 Mönchengladbach</option>
                                    <option>Dechant-Janssen-Weg 2, 41065 Mönchengladbach</option>
                                </select>
                            </label>
                        </p>
                        <p>
                            <label>Ziel:
                                <select name="margot_ziel" onchange="margotCalcShow()">
                                    <option>Dechant-Janssen-Weg 11, 41065 Mönchengladbach</option>
                                </select>
                            </label>
                        </p>
                        <p><input type="submit" name="margot_submit_show" value="Route berechnen und anzeigen"
                                  onclick="margotCalcShow()"/></p>
                        <p>
                            <label>Strahler:
                                <select name="margot_strahler">
                                </select>
                            </label>
                        </p>
                        <p><input type="submit" name="margot_submit_publish"
                                  value="Route berechnen und Annäherungsevent veröffentlichen"
                                  onclick="margotCalcPublish()"/>
                        </p>
                    </form>
                </td>
                <td>
                    <h2>Brigitte Feldmann</h2>
                    <form onsubmit="return false;">
                        <p>
                            <label>Start:
                                <select name="brigitte_start" onchange="brigitteCalcShow()">
                                    <option>Hardterbroicher Str. 107, 41065 Mönchengladbach</option>
                                    <option>Bungtstraße 1, 41065 Mönchengladbach</option>
                                    <option>Bungtstraße 2, 41065 Mönchengladbach</option>
                                    <option>Dechant-Janssen-Weg 2, 41065 Mönchengladbach</option>
                                </select>
                            </label>
                        </p>
                        <p>
                            <label>Ziel:
                                <select name="brigitte_ziel" onchange="brigitteCalcShow()">
                                    <option>Dechant-Janssen-Weg 11, 41065 Mönchengladbach</option>
                                </select>
                            </label>
                        </p>
                        <p><input type="submit" name="brigitte_submit_show" value="Route berechnen und anzeigen"
                                  onclick="brigitteCalcShow()"/></p>
                        <p>
                            <label>Strahler:
                                <select name="brigitte_strahler">
                                </select>
                            </label>
                        </p>
                        <p><input type="submit" name="brigitte_submit_publish"
                                  value="Route berechnen und Annäherungsevent veröffentlichen"
                                  onclick="brigitteCalcPublish()"/>
                        </p>
                    </form>
                </td>
            </tr>
        </table>
    </div>

    <script>
        /*<![CDATA[*/
        var map;
        var markers;
        var data;
        var mqttClient;
        var refreshJob;
        var refreshCounter = 0;

        var directionsService;
        var directionsDisplay;

        function initDemo() {
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 18,
                center: new google.maps.LatLng(51.1876702, 6.4605512),
                mapTypeId: 'hybrid'
            });
            directionsService = new google.maps.DirectionsService;
            directionsDisplay = new google.maps.DirectionsRenderer({preserveViewport: true});
            directionsDisplay.setMap(map);

            data = [];
            markers = [];

            var clientId = "ulp-web-" + Math.random().toString(36).substring(7);
            mqttClient = new Paho.MQTT.Client("ws://iot.eclipse.org:80/ws", clientId);

            mqttClient.onConnectionLost = onMqttConnectionLost;
            mqttClient.onMessageArrived = onMqttMessageArrived;

            mqttClient.connect({onSuccess: onMqttConnect});

            refreshJob = setInterval(refreshMap, 1500);
        }

        function onMqttConnect() {
            console.log("MQTT client connected.");
            mqttClient.subscribe("ulp/mir/status");
        }

        function onMqttConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0) {
                console.log("MQTT client connection lost:" + responseObject.errorMessage);
            }
        }

        function onMqttMessageArrived(message) {
            //console.log("MQTT message received: " + message.payloadString);
            updateData(message.payloadString);
        }

        function updateData(payload) {
            var status = JSON.parse(JSON.parse(payload).rawData);
            var statusIndex = findIndexOfStatus(status.mirId);
            if (statusIndex === -1) {
                data.push(status);
                addOptions(status.mirId);
            } else {
                data[statusIndex] = status;
            }
        }

        function addOptions(mirId) {
            var option = document.createElement("option");
            option.text = mirId;
            document.getElementsByName("margot_strahler")[0].add(option);
            document.getElementsByName("brigitte_strahler")[0].add(option);
        }

        function findIndexOfStatus(mirId) {
            return data.findIndex(function (status) {
                return status.mirId === mirId;
            })
        }

        function refreshMap() {
            //console.log("Refreshing map. %d data items.", data.length);
            data.forEach(refreshMirMarker);
            refreshCounter++;
        }

        function refreshMirMarker(item) {
            //console.log("Refreshing marker: %o", item);
            if (typeof findMarker(item.mirId) === 'undefined') {
                addMarker(item);
            }
            var marker = findMarker(item.mirId).marker;
            refreshMarkerColor(marker, item);
        }

        function findMarker(mirId) {
            return markers.find(function (marker) {
                return mirId === marker.mirId;
            });
        }

        function addMarker(item) {
            var coords = item.position;
            console.log("Adding marker for MIR " + item.mirId + " at Lat " + coords.lat + " and Lng " + coords.lng);
            var latLng = new google.maps.LatLng(coords.lat, coords.lng);

            var color = '#cecece';
            var circleMarker = new google.maps.Circle({
                strokeColor: '#ffffff',
                strokeOpacity: 0.95,
                strokeWeight: 3,
                fillColor: color,
                fillOpacity: 0.85,
                map: map,
                center: latLng,
                radius: 5
            });
            var marker = new google.maps.Marker({
                position: latLng,
                map: map,
                title: item.mirId,
                label: item.mirId
            });
            markers.push({
                mirId: item.mirId,
                marker: circleMarker
            });
        }

        function refreshMarkerColor(marker, item) {
            var colorCount = item.lightColors.length;
            var newColor = colorCount === 0 ? '#cecece' : item.lightColors[refreshCounter % colorCount];
            var newCircleOptions = {
                fillColor: newColor,
                //strokeColor: newColor
            };
            marker.setOptions(newCircleOptions);
        }

        function showDirections(origin, destination) {
            directionsService.route({
                origin: origin,
                destination: destination,
                travelMode: 'WALKING'
            }, function (response, status) {
                if (status === 'OK') {
                    directionsDisplay.setDirections(response);
                } else {
                    window.alert('Directions request failed due to ' + status);
                }
            });
        }

        function calcDirectionsAndPublishUserProximity(origin, destination, user, mirId) {
            directionsService.route({
                origin: origin,
                destination: destination,
                travelMode: 'WALKING'
            }, function (response, status) {
                if (status === 'OK') {
                    var mirMajorMinor = "333-" + mirId;
                    var topic = "ulp/sp/" + user.id + "/" + mirMajorMinor;
                    console.log("Path: " + response.routes[0].overview_path)
                    user.route = {
                        wayPoints: response.routes[0].overview_path
                    };
                    var event = {
                        user: user,
                        proximity: "NEAR",
                        mirIBeaconMajorMinor: mirMajorMinor
                    }
                    var message = new Paho.MQTT.Message(JSON.stringify(event));
                    message.destinationName = topic;
                    mqttClient.send(message);
                } else {
                    window.alert('Directions request failed due to ' + status);
                }
            });
        }

        /*** DEMO-SPECIFIC ***/

        function margotCalcShow() {
            var start = document.getElementsByName("margot_start")[0].value;
            var ziel = document.getElementsByName("margot_ziel")[0].value;

            showDirections(start, ziel);
        }

        function margotCalcPublish() {
            var start = document.getElementsByName("margot_start")[0].value;
            var ziel = document.getElementsByName("margot_ziel")[0].value;
            var strahler = document.getElementsByName("margot_strahler")[0].value;

            var user = {
                id: 123,
                firstName: "Margot",
                lastName: "Nowak",
                route: null,
                color: "BLUE",
                impairments: null
            };
            calcDirectionsAndPublishUserProximity(start, ziel, user, strahler);
        }

        /*]]>*/
    </script>
    <script async="async" defer="defer"
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAyoI0_b6XkPvj-_VpKcZfcwcYbJ1lV-80&amp;callback=initDemo">
    </script>
</div>
</body>
</html>