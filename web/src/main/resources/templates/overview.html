<!DOCTYPE html>
<!--
  ~ Copyright (c) 2017. Vitus Lehner. UrbanLife+. Universität der Bundeswehr München.
  -->

<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <meta charset="UTF-8"/>
    <title>UrbanLife+ Microinforadiator Overview</title>

    <style type="text/css">
        html, body {
            font-family: "Helvetica Neue", "Helvetica", sans-serif;
            background-color: #F2F1F2;
        }

        #wrapper {
            width: 95%;
            margin: 25px auto;
            padding: 20px;
            background-color: #FFFFFF;
            border: 1px solid #DDDDDD;
            border-radius: 5px;
        }

        #map {
            width: 100%;
            height: 500px;
        }
    </style>
    <!-- Eclipse Paho JavaScript MQTT Client -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"
            type="text/javascript"></script>
</head>
<body>
<div id="wrapper">
    <h2>Mikroinformationsstrahler</h2>
    <hr/>
    <p>UrbanLife+ | MIR-ID: <strong th:text="${mir_id}"/> <span th:text="${message}"/></p>
    <hr/>
    <div id="map"></div>

    <script>
        /*<![CDATA[*/
        var map;
        var markers;
        var data;
        var mqttClient;
        var refreshJob;
        var refreshCounter = 0;

        function initDemo() {
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 18,
                center: new google.maps.LatLng(51.1876702, 6.4605512),
                mapTypeId: 'hybrid'
            });

            data = [];
            markers = [];

            var clientId = "ulp-web-" + Math.random().toString(36).substring(7);
            mqttClient = new Paho.MQTT.Client("ws://iot.eclipse.org:80/ws", clientId);

            mqttClient.onConnectionLost = onMqttConnectionLost;
            mqttClient.onMessageArrived = onMqttMessageArrived;

            mqttClient.connect({onSuccess: onMqttConnect});

            refreshJob = setInterval(refreshMap, 1500);
        }

        function onMqttConnect() {
            console.log("MQTT client connected.");
            mqttClient.subscribe("ulp/mir/status");
        }

        function onMqttConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0) {
                console.log("MQTT client connection lost:" + responseObject.errorMessage);
            }
        }

        function onMqttMessageArrived(message) {
            console.log("MQTT message received: " + message.payloadString);
            updateData(message.payloadString);
        }

        function updateData(payload) {
            var status = JSON.parse(JSON.parse(payload).rawData);
            var statusIndex = findIndexOfStatus(status.mirId);
            if (statusIndex === -1) {
                data.push(status);
            } else {
                data[statusIndex] = status;
            }
        }

        function findIndexOfStatus(mirId) {
            return data.findIndex(function (status) {
                return status.mirId === mirId;
            })
        }

        function refreshMap() {
            console.log("Refreshing map. %d data items.", data.length);
            data.forEach(refreshMirMarker);
            refreshCounter++;
        }

        function refreshMirMarker(item) {
            console.log("Refreshing marker: %o", item);
            if (typeof findMarker(item.mirId) === 'undefined') {
                addMarker(item);
            }
            var marker = findMarker(item.mirId).marker;
            refreshMarkerColor(marker, item);
        }

        function findMarker(mirId) {
            return markers.find(function (marker) {
                return mirId === marker.mirId;
            });
        }

        function addMarker(item) {
            var coords = item.position;
            console.log("Adding marker for MIR " + item.mirId + " at Lat " + coords.lat + " and Lng " + coords.lng);
            var latLng = new google.maps.LatLng(coords.lat, coords.lng);

            var color = '#cecece';
            var circleMarker = new google.maps.Circle({
                strokeColor: '#ffffff',
                strokeOpacity: 0.95,
                strokeWeight: 3,
                fillColor: color,
                fillOpacity: 0.85,
                map: map,
                center: latLng,
                radius: 5
            });
            markers.push({
                mirId: item.mirId,
                marker: circleMarker
            });
        }

        function refreshMarkerColor(marker, item) {
            var colorCount = item.lightColors.length;
            var newColor = colorCount === 0 ? '#cecece' : item.lightColors[refreshCounter % colorCount];
            var newCircleOptions = {
                fillColor: newColor,
                //strokeColor: newColor
            };
            marker.setOptions(newCircleOptions);
        }

        /*]]>*/
    </script>
    <script async="async" defer="defer"
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAyoI0_b6XkPvj-_VpKcZfcwcYbJ1lV-80&amp;callback=initDemo">
    </script>
</div>
</body>
</html>